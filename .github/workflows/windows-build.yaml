name: Windows Build

on:
  push:
  workflow_dispatch:

jobs:
  windows-build:
    runs-on: windows-2022

    strategy:
      matrix:
        preset: [ msvc_debug, msvc_release ]

    steps:
      - uses: actions/checkout@v4

      - name: Configure (${{ matrix.preset }})
        env:
          VCPKG_ROOT: C:\vcpkg
        shell: pwsh
        run: |
          $outputFile = "configure_output.txt"

          cmake --preset ${{ matrix.preset }} 2>&1 | Tee-Object -FilePath $outputFile
          $exitCode = $LASTEXITCODE

          if ($exitCode -eq 0) {
            Add-Content $env:GITHUB_STEP_SUMMARY "<details><summary>ðŸŸ¢ Configure Results (click to expand)</summary>"
          } else {
            Add-Content $env:GITHUB_STEP_SUMMARY "## ðŸ”´ Configure Results"
          }

          Add-Content $env:GITHUB_STEP_SUMMARY ""
          Add-Content $env:GITHUB_STEP_SUMMARY '```'
          Get-Content $outputFile | Add-Content $env:GITHUB_STEP_SUMMARY
          Add-Content $env:GITHUB_STEP_SUMMARY '```'

          if ($exitCode -eq 0) {
            Add-Content $env:GITHUB_STEP_SUMMARY "</details>"
          }

          exit $exitCode

      - name: Build (${{ matrix.preset }})
        shell: pwsh
        run: |
          $outputFile = "build_output.txt"

          cmake --build --preset ${{ matrix.preset }} 2>&1 | Tee-Object -FilePath $outputFile
          $exitCode = $LASTEXITCODE

          if ($exitCode -eq 0) {
            Add-Content $env:GITHUB_STEP_SUMMARY "<details><summary>ðŸŸ¢ Build Results (click to expand)</summary>"
          } else {
            Add-Content $env:GITHUB_STEP_SUMMARY "## ðŸ”´ Build Results"
          }

          Add-Content $env:GITHUB_STEP_SUMMARY ""
          Add-Content $env:GITHUB_STEP_SUMMARY '```'
          Get-Content $outputFile | Add-Content $env:GITHUB_STEP_SUMMARY
          Add-Content $env:GITHUB_STEP_SUMMARY '```'

          if ($exitCode -eq 0) {
            Add-Content $env:GITHUB_STEP_SUMMARY "</details>"
          }

          exit $exitCode

      - name: Test (${{ matrix.preset }})
        shell: pwsh
        run: |
          $outputFile = "test_output.txt"

          ctest --preset ${{ matrix.preset }} --output-on-failure 2>&1 | Tee-Object -FilePath $outputFile
          $exitCode = $LASTEXITCODE

          if ($exitCode -eq 0) {
            Add-Content $env:GITHUB_STEP_SUMMARY "<details><summary>ðŸŸ¢ Test Results (click to expand)</summary>"
          } else {
            Add-Content $env:GITHUB_STEP_SUMMARY "## ðŸ”´ Test Results"
          }

          Add-Content $env:GITHUB_STEP_SUMMARY ""
          Add-Content $env:GITHUB_STEP_SUMMARY '```'
          Get-Content $outputFile | Add-Content $env:GITHUB_STEP_SUMMARY
          Add-Content $env:GITHUB_STEP_SUMMARY '```'

          if ($exitCode -eq 0) {
            Add-Content $env:GITHUB_STEP_SUMMARY "</details>"
          }

          exit $exitCode
