name: Linux Build Test

on:
  push:
  workflow_dispatch:

permissions:
  contents: read
  packages: read

jobs:
  linux-build:
    runs-on: ubuntu-latest
    name: ${{ matrix.test_preset }}

    permissions:
      # coverage artefacts export requires write priviledges
      # (html report and shields.io badge)
      contents: write

    strategy:
      matrix:
        include:
          - name: clang_debug
            configure_preset: clang_debug
            build_preset: clang_debug
            test_preset: quick-validation-clang-debug

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            clang \
            clang-tidy \
            llvm \
            gcc \
            g++ \
            git \
            curl \
            zip \
            unzip \
            pkg-config \
            ninja-build \
            cmake

      - name: Setup vcpkg
        run: |
          git clone https://github.com/microsoft/vcpkg.git /tmp/vcpkg
          /tmp/vcpkg/bootstrap-vcpkg.sh
          echo "VCPKG_ROOT=/tmp/vcpkg" >> $GITHUB_ENV
          echo "/tmp/vcpkg" >> $GITHUB_PATH

      - name: Cache VCPKG
        uses: actions/cache@v4
        with:
          path: |
            /tmp/vcpkg/downloads
            /tmp/vcpkg/installed
            ~/.cache/vcpkg
          key: ${{ runner.os }}-vcpkg-${{ matrix.name }}-${{ hashFiles('vcpkg.json') }}
          restore-keys: ${{ runner.os }}-vcpkg-

      - name: Cache build
        uses: actions/cache@v4
        with:
          path: build
          key: ${{ runner.os }}-cmake-${{ matrix.name }}-${{ hashFiles('CMakeLists.txt', '**/*.cmake') }}
          restore-keys: ${{ runner.os }}-cmake-

      - name: Configure (${{ matrix.configure_preset }})
        shell: bash
        run: |
          set +e
          cmake --preset ${{ matrix.configure_preset }} 2>&1 | tee configure_output.txt
          CONFIGURE_EXIT_CODE=${PIPESTATUS[0]}  # Capture CMake exit code, not tee
          set -e

          if [ $CONFIGURE_EXIT_CODE -eq 0 ]; then
            echo "<details><summary>游릭 Configure Results (click to expand)</summary>" >> $GITHUB_STEP_SUMMARY
          else
            echo "## 游댮 Configure Results" >> $GITHUB_STEP_SUMMARY
          fi
          echo '' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat configure_output.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          if [ $CONFIGURE_EXIT_CODE -eq 0 ]; then
            echo "</details>" >> $GITHUB_STEP_SUMMARY
          fi

          exit $CONFIGURE_EXIT_CODE

      - name: Build (${{ matrix.build_preset }})
        shell: bash
        run: |
          set +e
          cmake --build --preset ${{ matrix.build_preset }} 2>&1 | tee build_output.txt
          BUILD_EXIT_CODE=${PIPESTATUS[0]}  # Capture CMake exit code, not tee
          set -e

          if [ $BUILD_EXIT_CODE -eq 0 ]; then
            echo "<details><summary>游릭 Build Results (click to expand)</summary>" >> $GITHUB_STEP_SUMMARY
          else
            echo "## 游댮 Build Results" >> $GITHUB_STEP_SUMMARY
          fi
          echo '' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat build_output.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          if [ $BUILD_EXIT_CODE -eq 0 ]; then
            echo "</details>" >> $GITHUB_STEP_SUMMARY
          fi

          exit $BUILD_EXIT_CODE

      - name: Test (${{ matrix.test_preset }})
        shell: bash
        run: |
          set +e
          ctest --preset ${{ matrix.test_preset }} --output-on-failure 2>&1 | tee test_output.txt
          TEST_EXIT_CODE=${PIPESTATUS[0]}  # Capture CMake exit code, not tee
          set -e

          if [ $TEST_EXIT_CODE -eq 0 ]; then
            echo "<details><summary>游릭 Test Results (click to expand)</summary>" >> $GITHUB_STEP_SUMMARY
          else
            echo "## 游댮 Test Results" >> $GITHUB_STEP_SUMMARY
          fi
          echo '' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat test_output.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          if [ $TEST_EXIT_CODE -eq 0 ]; then
            echo "</details>" >> $GITHUB_STEP_SUMMARY
          fi

          exit $TEST_EXIT_CODE

      - name: Generate markdown coverage report (${{ matrix.test_preset }})
        shell: bash
        run: |
          set +e
          cmake --build --preset ${{ matrix.build_preset }} --target coverage-markdown 2>&1 | tee coverage_gh_summary.txt
          COV_EXIT_CODE=${PIPESTATUS[0]}  # Capture CMake exit code, not tee
          set -e

          COVERAGE_FILE=$(grep -Po "GitHub Markdown summary written to: \K.*" coverage_gh_summary.txt)
          # -P: Uses Perl-style regex.
          # -o: Only outputs the matched part (not the whole line).
          # \K: Tells the engine to match the string but ignore it in the final output.
          # .*: Matches the rest of the line (the path)

          if [ $COV_EXIT_CODE -eq 0 ]; then
            echo "<details><summary>游릭 Coverage Results (click to expand)</summary>" >> $GITHUB_STEP_SUMMARY
          else
            echo "## 游댮 Coverage Results" >> $GITHUB_STEP_SUMMARY
          fi
          echo '' >> $GITHUB_STEP_SUMMARY
          cat $COVERAGE_FILE >> $GITHUB_STEP_SUMMARY
          if [ $COV_EXIT_CODE -eq 0 ]; then
            echo "</details>" >> $GITHUB_STEP_SUMMARY
          fi

          exit $COV_EXIT_CODE

      - name: Generate html coverage report (${{ matrix.test_preset }})
        #if: github.ref_name == 'main'
        id: htmlcov
        shell: bash
        run: |
          set +e
          cmake --build --preset ${{ matrix.build_preset }} --target coverage-html 2>&1 | tee coverage_html_summary.txt
          COV_EXIT_CODE=${PIPESTATUS[0]}  # Capture CMake exit code, not tee
          set -e

          HTML_COV_DIR=$(grep -Po "HTML coverage directory: \K.*" coverage_html_summary.txt)
          echo "HTML_COV_DIR=$HTML_COV_DIR" >> "$GITHUB_OUTPUT"

          exit $COV_EXIT_CODE

      - name: Generate shields.io badge (${{ matrix.test_preset }})
        #if: github.ref_name == 'main'
        id: shieldsio
        shell: bash
        run: |
          set +e
          cmake --build --preset ${{ matrix.build_preset }} --target coverage-shieldsio 2>&1 | tee coverage_shieldsio_summary.txt
          COV_EXIT_CODE=${PIPESTATUS[0]}  # Capture CMake exit code, not tee
          set -e

          SHIELDSIO_BADGE_FILE=$(grep -Po "Shields.io badge written to: \K.*" coverage_shieldsio_summary.txt)
          echo "SHIELDSIO_BADGE_FILE=$SHIELDSIO_BADGE_FILE" >> "$GITHUB_OUTPUT"

          exit $COV_EXIT_CODE

      - name: Prepare files
        shell: bash
        run: |
          mkdir -p out/
          cp -r "${{ steps.htmlcov.outputs.HTML_COV_DIR }}" out/
          cp "${{ steps.shieldsio.outputs.SHIELDSIO_BADGE_FILE }}" out/

      - name: Publish coverage badge and report to gh-pages
        #if: github.ref_name == 'main'
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: out
          keep_files: true
