name: Windows Build Test

on:
  push:
  workflow_dispatch:

jobs:
  windows-build:
    runs-on: windows-2022

    strategy:
      matrix:
        include:
          name: msvc_release
          configure_preset: msvc_release
          build_preset: msvc_release
          test_preset: quick-validation-msvc_release

    steps:
      - uses: actions/checkout@v4

      - name: Cache VCPKG
        uses: actions/cache@v4
        with:
          path: |
            C:\vcpkg\installed
            C:\vcpkg\packages
            C:\vcpkg\buildtrees
            ~\AppData\Local\vcpkg\archives
          key: ${{ runner.os }}-vcpkg-${{ matrix.name }}-${{ hashFiles('vcpkg.json') }}
          restore-keys: ${{ runner.os }}-vcpkg-

      - name: Cache build
        uses: actions/cache@v4
        with:
          path: build
          key: ${{ runner.os }}-cmake-${{ matrix.name }}-${{ hashFiles('CMakeLists.txt', '**/*.cmake') }}
          restore-keys: ${{ runner.os }}-cmake-

      - name: Configure (${{ matrix.configure_preset }})
        env:
          VCPKG_ROOT: C:\vcpkg
        shell: pwsh
        run: |
          $outputFile = "configure_output.txt"

          cmake --preset ${{ matrix.configure_preset }} 2>&1 | Tee-Object -FilePath $outputFile
          $exitCode = $LASTEXITCODE

          if ($exitCode -eq 0) {
            Add-Content $env:GITHUB_STEP_SUMMARY "<details><summary>ðŸŸ¢ Configure Results (click to expand)</summary>"
          } else {
            Add-Content $env:GITHUB_STEP_SUMMARY "## ðŸ”´ Configure Results"
          }

          Add-Content $env:GITHUB_STEP_SUMMARY ""
          Add-Content $env:GITHUB_STEP_SUMMARY '```'
          Get-Content $outputFile | Add-Content $env:GITHUB_STEP_SUMMARY
          Add-Content $env:GITHUB_STEP_SUMMARY '```'

          if ($exitCode -eq 0) {
            Add-Content $env:GITHUB_STEP_SUMMARY "</details>"
          }

          exit $exitCode

      - name: Build (${{ matrix.build_preset }})
        shell: pwsh
        run: |
          $outputFile = "build_output.txt"

          cmake --build --preset ${{ matrix.build_preset }} 2>&1 | Tee-Object -FilePath $outputFile
          $exitCode = $LASTEXITCODE

          if ($exitCode -eq 0) {
            Add-Content $env:GITHUB_STEP_SUMMARY "<details><summary>ðŸŸ¢ Build Results (click to expand)</summary>"
          } else {
            Add-Content $env:GITHUB_STEP_SUMMARY "## ðŸ”´ Build Results"
          }

          Add-Content $env:GITHUB_STEP_SUMMARY ""
          Add-Content $env:GITHUB_STEP_SUMMARY '```'
          Get-Content $outputFile | Add-Content $env:GITHUB_STEP_SUMMARY
          Add-Content $env:GITHUB_STEP_SUMMARY '```'

          if ($exitCode -eq 0) {
            Add-Content $env:GITHUB_STEP_SUMMARY "</details>"
          }

          exit $exitCode

      - name: Test (${{ matrix.test_preset }})
        shell: pwsh
        run: |
          $outputFile = "test_output.txt"

          ctest --preset ${{ matrix.test_preset }} --output-on-failure 2>&1 | Tee-Object -FilePath $outputFile
          $exitCode = $LASTEXITCODE

          if ($exitCode -eq 0) {
            Add-Content $env:GITHUB_STEP_SUMMARY "<details><summary>ðŸŸ¢ Test Results (click to expand)</summary>"
          } else {
            Add-Content $env:GITHUB_STEP_SUMMARY "## ðŸ”´ Test Results"
          }

          Add-Content $env:GITHUB_STEP_SUMMARY ""
          Add-Content $env:GITHUB_STEP_SUMMARY '```'
          Get-Content $outputFile | Add-Content $env:GITHUB_STEP_SUMMARY
          Add-Content $env:GITHUB_STEP_SUMMARY '```'

          if ($exitCode -eq 0) {
            Add-Content $env:GITHUB_STEP_SUMMARY "</details>"
          }

          exit $exitCode
